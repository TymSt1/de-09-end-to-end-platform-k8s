name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install flake8 black pytest
          pip install -r src/producer/requirements.txt
          pip install -r src/consumer/requirements.txt

      - name: Lint with flake8
        run: |
          flake8 src/ --max-line-length=120 --ignore=E501,W503,E203

      - name: Check formatting with black
        run: |
          black --check --line-length=120 src/

  validate-k8s:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubeval
        run: |
          wget -q https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: |
          find k8s/ -name '*.yaml' -not -path '*/orchestration/*' | xargs kubeval --strict --ignore-missing-schemas || true

  validate-terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt check
        run: |
          cd terraform
          terraform fmt -check

      - name: Terraform validate
        run: |
          cd terraform
          terraform init -backend=false
          terraform validate

  validate-dbt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dbt
        run: pip install dbt-postgres==1.9.0

      - name: Validate dbt project
        run: |
          cd src/airflow/dbt
          dbt parse --profiles-dir . || true

  build-images:
    runs-on: ubuntu-latest
    needs: [lint-and-test, validate-k8s, validate-terraform, validate-dbt]
    steps:
      - uses: actions/checkout@v4

      - name: Build producer image
        run: docker build -t taxi-producer:latest src/producer/

      - name: Build consumer image
        run: docker build -t taxi-consumer:latest src/consumer/

      - name: Build Spark image
        run: docker build -t taxi-spark:latest src/spark/

      - name: Build Streamlit image
        run: docker build -t taxi-streamlit:latest src/streamlit/

      - name: Build Airflow image
        run: docker build -t custom-airflow:latest src/airflow/

      - name: All images built successfully
        run: echo "All 5 Docker images built successfully"